# セキュリティチェック項目

IPAで公開されている脆弱性の種類ごとにNablarchでの対応状況を記載

**出典**: IPA 安全なウェブサイトの作り方

> Nablarchで対応できないものについては、プロジェクトで個別に対応を検討。根本的解決となっているものについては必ず対応すること

**公式ドキュメント**:
- [セキュリティチェック項目](システム開発ガイド/設計書/Nablarch機能のセキュリティ対応表.xlsx)

---

## 1. SQLインジェクション

Nablarchはデータベースアクセス機能として、簡易的なO/Rマッパーを実現するユニバーサルDAOと、JDBCを使いやすくしたJDBCラッパーを提供しています。どちらの機能でもSQL文を外部ファイルに記述し、PreparedStatement を使用したSQL実行の仕組みを提供しており、SQLインジェクションの脆弱性を排除できます。
また、使用不許可APIの使用を検出するツールも提供しており、このツールでチェックすることでNablarchの提供するデータベースアクセス以外の方式を検出することが可能です。

上記に加え、HTTPエラー制御ハンドラを使用することでエラーメッセージやスタックトレースがユーザに表示されることを防ぎ、より強固なアプリケーションとすることが可能です。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | SQL文の組み立ては全てプレースホルダで実装する。 | データベースアクセス（JDBCラッパー）
ユニバーサルDAO | 〇 | 1-(i)-a |
|  | SQL文の構成を文字列連結により行う場合は、アプリケーションの変数をSQL文のリテラルとして正しく構成する。 | データベースアクセス（JDBCラッパー）
ユニバーサルDAO | 〇 | 1-(i)-b |
| 根本的解決 | ウェブアプリケーションに渡されるパラメータにSQL文を直接指定しない。 | データベースアクセス（JDBCラッパー）
ユニバーサルDAO | 〇 | 1-(ii) |
| 保険的対策 | エラーメッセージをそのままブラウザに表示しない。 | HTTPエラー制御ハンドラ | 〇 | 1-(iii) |
| 保険的対策 | データベースアカウントに適切な権限を与える。 | - | × | 1-(iv) |

**SQL文の組み立ては全てプレースホルダで実装する。**:

Nablarchはデータベースアクセス機能として、簡易的なO/Rマッパーを実現するユニバーサルDAOと、JDBCを使いやすくしたJDBCラッパーを提供しています。どちらの機能でもSQL文を外部ファイルに記述し、PreparedStatement を使用したSQL実行の仕組みを提供しており、SQLインジェクションの脆弱性を排除できます。
また、使用不許可APIの使用を検出するツールも提供しており、このツールでチェックすることでNablarchの提供するデータベースアクセス以外の方式を検出することが可能です。

上記に加え、HTTPエラー制御ハンドラを使用することでエラーメッセージやスタックトレースがユーザに表示されることを防ぎ、より強固なアプリケーションとすることが可能です。

---

## 2. OSコマンド・インジェクション

使用不許可APIの使用を検出するツールを提供しています。このツールでチェックすることでRuntimeなどOSコマンドを実行する機能の使用箇所を検出することができます。
システムとして一律OSコマンドの使用を禁止する場合は上記の対応で根本的解決が見込めます。
システム要件としてOSコマンドの使用が必要な場合には右記の保険的対策をプロジェクトの方式として取り入れるようにしてください。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | シェルを起動できる言語機能の利用を避ける。 | 許可していないAPIが使用されていないかチェックする | 〇 | 2-(i) |
| 保険的対策 | シェルを起動できる言語機能を利用する場合は、その引数を構成する全ての変数に対してチェックを行い、あらかじめ許可した処理のみを実行する。 | - | × | 2-(ii) |

**シェルを起動できる言語機能の利用を避ける。**:

使用不許可APIの使用を検出するツールを提供しています。このツールでチェックすることでRuntimeなどOSコマンドを実行する機能の使用箇所を検出することができます。
システムとして一律OSコマンドの使用を禁止する場合は上記の対応で根本的解決が見込めます。
システム要件としてOSコマンドの使用が必要な場合には右記の保険的対策をプロジェクトの方式として取り入れるようにしてください。

---

## 3. パス名パラメータの未チェック／ディレクトリ・トラバーサル

Nablarchではファイルパス管理機能を提供しています。サーバ内のファイルへのアクセスにこの機能を使用することで、アクセス対象のベースディレクトリを指定することができます。これにより公開するディレクトリが限定されます。同時に、特定の拡張子のファイルのみにアクセスさせることがきます。
ファイル名をユーザに入力させる場合、上記に組み合わせて、入力値チェックで "."などの文字を許容しないことでディレクトリトラバーサルを防ぐことが可能となります。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | 外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装を避ける。 | ファイルパス管理 | 〇 | 3-(i)-a |
|  | ファイルを開く際は、固定のディレクトリを指定し、かつファイル名にディレクトリ名が含まれないようにする。 | ファイルパス管理 | 〇 | 3-(i)-b |
| 保険的対策 | ウェブサーバ内のファイルへのアクセス権限の設定を正しく管理する。 | - | × | 3-(ii) |
| 保険的対策 | ファイル名のチェックを行う。 | 入力値のチェック | 〇 | 3-(iii) |

**外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装を避ける。**:

Nablarchではファイルパス管理機能を提供しています。サーバ内のファイルへのアクセスにこの機能を使用することで、アクセス対象のベースディレクトリを指定することができます。これにより公開するディレクトリが限定されます。同時に、特定の拡張子のファイルのみにアクセスさせることがきます。
ファイル名をユーザに入力させる場合、上記に組み合わせて、入力値チェックで "."などの文字を許容しないことでディレクトリトラバーサルを防ぐことが可能となります。

---

## 4. セッション管理の不備

NablarchはHTTPセッションを抽象化したものとしてセッションストア機能を提供しています。
セッションストアでは以下の機能を提供しており、セッション管理の脆弱性について根本的解決が見込めます。
　・　セッションを追跡するためセッションIDをCookieに格納します。
　・　セッションIDには推測困難なUUIDを使用しています。
　・　セッションストアのデフォルト設定では、HTTPヘッダーのSet-Cookieにsecure属性を設定していません。
　　　HTTPSを利用する際は設定でsecure属性を指定してください。
　・　セッション作成ごとにセッションID採番を行っています。
　・　セッションストアのデフォルト設定では、CookieにMaxAge属性を設定しません。
　　　そのため、Cookieの有効期限はブラウザが閉じるまでとなります。

4-(iv)についてはNablarchのExampleで提供している、ログイン処理の実装例を参考に、ログイン成功後に新しくセッションを開始するようプロジェクトで対応してください。



| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | セッションIDを推測が困難なものにする。 | セッションストア | 〇 | 4-(i) |
| 根本的解決 | セッションIDをURLパラメータに格納しない。 | セッションストア | 〇 | 4-(ii) |
| 根本的解決 | HTTPS通信で利用するCookieにはsecure属性を加える。 | セッションストア | 〇 | 4-(iii) |
| 根本的解決 | ログイン成功後に、新しくセッションを開始する。 | Nablarch Example | △ | 4-(iv)-a |
|  | ログイン成功後に、既存のセッションIDとは別に秘密情報を発行し、ページの遷移ごとにその値を確認する。 | 4-(iv)-a の対策を実施する |  | 4-(iv)-b |
| 保険的対策 | セッションIDを固定値にしない。 | セッションストア | 〇 | 4-(v) |
| 保険的対策 | セッションIDをCookieにセットする場合、有効期限の設定に注意する。 | セッションストア | 〇 | 4-(vi) |

**セッションIDを推測が困難なものにする。**:

NablarchはHTTPセッションを抽象化したものとしてセッションストア機能を提供しています。
セッションストアでは以下の機能を提供しており、セッション管理の脆弱性について根本的解決が見込めます。
　・　セッションを追跡するためセッションIDをCookieに格納します。
　・　セッションIDには推測困難なUUIDを使用しています。
　・　セッションストアのデフォルト設定では、HTTPヘッダーのSet-Cookieにsecure属性を設定していません。
　　　HTTPSを利用する際は設定でsecure属性を指定してください。
　・　セッション作成ごとにセッションID採番を行っています。
　・　セッションストアのデフォルト設定では、CookieにMaxAge属性を設定しません。
　　　そのため、Cookieの有効期限はブラウザが閉じるまでとなります。

4-(iv)についてはNablarchのExampleで提供している、ログイン処理の実装例を参考に、ログイン成功後に新しくセッションを開始するようプロジェクトで対応してください。



---

## 5. クロスサイト・スクリプティング

Nablarchのカスタムタグはサニタイジングを行います。これによりNablarchのカスタムタグを使った場合には5-(i)の根本的解決が可能です。
また、NablarchはJSPで使用を許可する構文とタグを規定し、許可する構文とタグのみを使用していることをチェックするJSP静的解析ツールを提供しています。このツールを使用することでカスタムタグ以外のタグを使用したことによるエスケープ漏れを防止することが可能です。

https://nablarch.github.io/docs/LATEST/doc/development_tools/toolbox/JspStaticAnalysis/01_JspStaticAnalysis.html

5-(ii)～(iv)の対策についてはプロジェクトで対応してください。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | ウェブページに出力する全ての要素に対して、エスケープ処理を施す。 | カスタムタグ | 〇 | 5-(i) |
| 根本的解決 | URLを出力するときは、「http://」や 「https://」で始まるURLのみを許可する。 | - | × | 5-(ii) |
| 根本的解決 | <script>...</script> 要素の内容を動的に生成しない。 | - | × | 5-(iii) |
| 根本的解決 | スタイルシートを任意のサイトから取り込めるようにしない。 | - | × | 5-(iv) |
| 保険的対策 | 入力値の内容チェックを行う。 | 入力値のチェック | 〇 | 5-(v) |
| 根本的解決 | 入力されたHTMLテキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出する。 | - | × | 5-(vi) |
| 保険的対策 | 入力されたHTMLテキストから、スクリプトに該当する文字列を排除する。 | - | × | 5-(vii) |
| 根本的解決 | HTTPレスポンスヘッダのContent-Typeフィールドに文字コード（charset）の指定を行う。 | HTTP文字エンコード制御ハンドラ | 〇 | 5-(viii) |
| 保険的対策 | Cookie情報の漏えい対策として、発行するCookieにHttpOnly属性を加え、TRACEメソッドを無効化する。 | - | × | 5-(ix) |
| 保険的対策 | クロスサイト・スクリプティングの潜在的な脆弱性対策として有効なブラウザの機能を有効にするレスポンスヘッダを返す。 | セキュアハンドラ | 〇 | 5-(x) |

**ウェブページに出力する全ての要素に対して、エスケープ処理を施す。**:

Nablarchのカスタムタグはサニタイジングを行います。これによりNablarchのカスタムタグを使った場合には5-(i)の根本的解決が可能です。
また、NablarchはJSPで使用を許可する構文とタグを規定し、許可する構文とタグのみを使用していることをチェックするJSP静的解析ツールを提供しています。このツールを使用することでカスタムタグ以外のタグを使用したことによるエスケープ漏れを防止することが可能です。

https://nablarch.github.io/docs/LATEST/doc/development_tools/toolbox/JspStaticAnalysis/01_JspStaticAnalysis.html

5-(ii)～(iv)の対策についてはプロジェクトで対応してください。

**入力されたHTMLテキストから構文解析木を作成し、スクリプトを含まない必要な要素のみを抽出する。**:

以下のような方法での対応を検討してください。

・OSSのHTMLパーサを使用して入力された値をパースし、使用できないHTMLタグが含まれていないかをバリデーションする
・簡易的な装飾であれば、利用者にはMarkdownで入力してもらい、 OSSのJavaScriptライブラリを使用してクライアントサイドでMarkdownからHTMLに変換する

**HTTPレスポンスヘッダのContent-Typeフィールドに文字コード（charset）の指定を行う。**:

NablarchはHTTPレスポンスのHTTPヘッダのContent-TypeにMIME Type・文字コードを設定しています。これにより特定のブラウザで発生し得る 5-(i) の対策を回避したクロスサイト・スクリプティングを防ぐことができます。
また、Nablarchはセキュリティ関連のヘッダをレスポンスオブジェクトに設定するセキュアハンドラを提供しています。このハンドラにより、ユーザがクロスサイト・スクリプティングの脆弱性対策を無効にしていた場合でもサーバからブラウザの機能を有効にするよう指示することが可能です。

---

## 6. CSRF
（クロスサイト・リクエスト・フォージェリ）

CSRF対策として、NablarchのCSRF対策機能を使用できます。この機能は一意なトークンを発行し、サーバサイドでチェックすることで不正な画面遷移を防ぎます。

NablarchのHttpSessionを使用した二重サブミット防止機能を使用した場合も、CSRF対策機能と同じ効果が得られCSRF対策として機能します。CSRF対策機能はハンドラを追加するだけで漏れなくチェックできるのに対し、二重サブミット防止機能はアプリケーションプログラマが明示的に実装する必要があり、CSRF対策が洩れる可能性があります。そのため、CSRF対策にはCSRF対策機能の使用を推奨します。

データベースを使用した二重サブミット防止機能はCSRF対策に対応していません。データベースを使用した二重サブミット防止機能を使用する場合はCSRF対策機能を使用してください。


| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | 処理を実行するページを POST メソッドでアクセスするようにし、その「hidden パラメータ」に秘密情報が挿入されるよう、前のページを自動生成して、実行ページではその値が正しい場合のみ処理を実行する。 | CSRF対策 | 〇 | 6-(i)-a |
|  | 処理を実行する直前のページで再度パスワードの入力を求め、実行ページでは、再度入力されたパスワードが正しい場合のみ処理を実行する。 | 6-(i)-a の対策を実施する |  | 6-(i)-b |
|  | Refererが正しいリンク元かを確認し、正しい場合のみ処理を実行する。 | 6-(i)-a の対策を実施する |  | 6-(i)-c |
| 保険的対策 | 重要な操作を行った際に、その旨を登録済みのメールアドレスに自動送信する。 | - | × | 6-(ii) |

**処理を実行するページを POST メソッドでアクセスするようにし、その「hidden パラメータ」に秘密情報が挿入されるよう、前のページを自動生成して、実行ページではその値が正しい場合のみ処理を実行する。**:

CSRF対策として、NablarchのCSRF対策機能を使用できます。この機能は一意なトークンを発行し、サーバサイドでチェックすることで不正な画面遷移を防ぎます。

NablarchのHttpSessionを使用した二重サブミット防止機能を使用した場合も、CSRF対策機能と同じ効果が得られCSRF対策として機能します。CSRF対策機能はハンドラを追加するだけで漏れなくチェックできるのに対し、二重サブミット防止機能はアプリケーションプログラマが明示的に実装する必要があり、CSRF対策が洩れる可能性があります。そのため、CSRF対策にはCSRF対策機能の使用を推奨します。

データベースを使用した二重サブミット防止機能はCSRF対策に対応していません。データベースを使用した二重サブミット防止機能を使用する場合はCSRF対策機能を使用してください。


---

## 7. HTTPヘッダ・インジェクション

Nablarchでのヘッダ出力はHttpServletResponseのAPIを使用しているため、Nablarchを使用する場合はヘッダにおける改行の扱いをAPIに移譲することでHTTPヘッダ・インジェクションの対策が可能です。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | ヘッダの出力を直接行わず、ウェブアプリケーションの実行環境や言語に用意されているヘッダ出力用APIを使用する。 | Nablarchで提供する機能全般 | 〇 | 7-(i)-a |
|  | 改行コードを適切に処理するヘッダ出力用APIを利用できない場合は、改行を許可しないよう、開発者自身で適切な処理を実装する。 | 7-(i)-a の対策を実施する |  | 7-(i)-b |
| 保険的対策 | 外部からの入力の全てについて、改行コードを削除する。 | - | × | 7-(ii) |

**ヘッダの出力を直接行わず、ウェブアプリケーションの実行環境や言語に用意されているヘッダ出力用APIを使用する。**:

Nablarchでのヘッダ出力はHttpServletResponseのAPIを使用しているため、Nablarchを使用する場合はヘッダにおける改行の扱いをAPIに移譲することでHTTPヘッダ・インジェクションの対策が可能です。

---

## 8. メールヘッダ・インジェクション

Nablarchはメール送信機能を提供しており、メールヘッダインジェクション攻撃への対策をガイドしています。
　・メールヘッダは固定値を使用する。外部からの入力値を使用しない。
　・プログラミング言語の標準APIを使用してメール送信を行う。Javaの場合は JavaMail APIを使用する。

8-(ii)についてはプロジェクトで対応してください。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | メールヘッダを固定値にして、外部からの入力はすべてメール本文に出力する。 | メール送信 | △ | 8-(i)-a |
|  | ウェブアプリケーションの実行環境や言語に用意されているメール送信用APIを使用する（8-(i) を採用できない場合）。 | メール送信 | △ | 8-(i)-b |
| 根本的解決 | HTMLで宛先を指定しない。 | - | × | 8-(ii) |
| 保険的対策 | 外部からの入力の全てについて、改行コードを削除する。 | - | × | 8-(iii) |

**メールヘッダを固定値にして、外部からの入力はすべてメール本文に出力する。**:

Nablarchはメール送信機能を提供しており、メールヘッダインジェクション攻撃への対策をガイドしています。
　・メールヘッダは固定値を使用する。外部からの入力値を使用しない。
　・プログラミング言語の標準APIを使用してメール送信を行う。Javaの場合は JavaMail APIを使用する。

8-(ii)についてはプロジェクトで対応してください。

---

## 9. クリックジャッキング

Nablarchはセキュリティ関連のヘッダをレスポンスオブジェクトに設定するセキュアハンドラを提供しています。このハンドラにより、デフォルトで X-Frame-Options: SAMEORIGIN が出力されるため、クリックジャッキング対策が可能です。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | HTTPレスポンスヘッダに、X-Frame-Optionsヘッダフィールドを出力し、他ドメインのサイトからのframe要素やiframe要素による読み込みを制限する。 | セキュアハンドラ | 〇 | 9-(i)-a |
|  | 処理を実行する直前のページで再度パスワードの入力を求め、実行ページでは、再度入力されたパスワードが正しい場合のみ処理を実行する。 | 9-(i)-a の対策を実施する |  | 9-(i)-b |
| 保険的対策 | 重要な処理は、一連の操作をマウスのみで実行できないようにする。 | - | × | 9-(ii) |

**HTTPレスポンスヘッダに、X-Frame-Optionsヘッダフィールドを出力し、他ドメインのサイトからのframe要素やiframe要素による読み込みを制限する。**:

Nablarchはセキュリティ関連のヘッダをレスポンスオブジェクトに設定するセキュアハンドラを提供しています。このハンドラにより、デフォルトで X-Frame-Options: SAMEORIGIN が出力されるため、クリックジャッキング対策が可能です。

---

## 10. バッファオーバーフロー

NablarchはJavaで記述されているため、言語レベルでバッファオーバーフローの脆弱性はありません。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | 直接メモリにアクセスできない言語で記述する。 | Nablarchで提供する機能全般 | 〇 | 10-(i)-a |
|  | 直接メモリにアクセスできる言語で記述する部分を最小限にする。 | Nablarchで提供する機能全般 | 〇 | 10-(i)-b |
| 根本的解決 | 脆弱性が修正されたバージョンのライブラリを使用する。 | Nablarchで提供する機能全般 | 〇 | 10-(ii) |

**直接メモリにアクセスできない言語で記述する。**:

NablarchはJavaで記述されているため、言語レベルでバッファオーバーフローの脆弱性はありません。

---

## 11. アクセス制御や認可制御の欠落

Nablarchは認証チェックを行う機能を提供していません。NablarchのExampleとして提供している実装例を参考に認証機能を実装してください。
Nablarchは認可チェック機能を提供しています。この機能は、細かく権限を設定できる反面、非常に細かいデータ設計が必要となり、 開発時の生産性低下やリリース後の運用負荷が高まる可能性があります。プロジェクトでは、システム要件に適合する場合に使用してください。

| 種別 | 説明 | Nablarch機能 | 対応 | 参照 |
|------|------|--------------|:----:|------|
| 根本的解決 | アクセス制御機能による防御措置が必要とされるウェブサイトには、パスワード等の秘密情報の入力を必要とする認証機能を設ける。 | Nablarch Example | △ | 11-(i) |
| 根本的解決 | 認証機能に加えて認可制御の処理を実装し、ログイン中の利用者が他人になりすましてアクセスできないようにする。 | 認可チェック | 〇 | 11-(ii) |

**アクセス制御機能による防御措置が必要とされるウェブサイトには、パスワード等の秘密情報の入力を必要とする認証機能を設ける。**:

Nablarchは認証チェックを行う機能を提供していません。NablarchのExampleとして提供している実装例を参考に認証機能を実装してください。
Nablarchは認可チェック機能を提供しています。この機能は、細かく権限を設定できる反面、非常に細かいデータ設計が必要となり、 開発時の生産性低下やリリース後の運用負荷が高まる可能性があります。プロジェクトでは、システム要件に適合する場合に使用してください。

---

## Tips

**チェック項目の実施方法**:

※印のチェック項目は、実施項目のいずれかを実施すればよい（全てを実施する必要はない）

**保険的対策の判断**:

保険的対策については、システム要件に合わせて対応要否を判断すること。根本的解決が基本だが、実現困難な場合の補完として検討

**根本的解決の優先**:

根本的解決となっている対策は必ず実施すること。脆弱性の原因そのものを排除する対策であり、セキュリティの基本

---
