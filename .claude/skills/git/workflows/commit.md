# コミット・プッシュワークフロー

このワークフローは、変更をコミットしてリモートにプッシュします。

## 必要なツール

- Bash
- AskUserQuestion

## 実行ステップ

### 1. 事前確認

**1.1 カレントブランチの確認**

```bash
git branch --show-current
```

カレントブランチが`main`または`master`の場合は警告表示（エラーではない）:
```
警告: mainブランチに直接コミットしようとしています。
作業ブランチで作業することを推奨します。

続行しますか？
```

**1.2 変更の確認**

```bash
git status --porcelain
```

変更がない場合はエラー終了:
```
エラー: コミットする変更がありません。

現在の状態を確認:
git status
```

### 2. 変更の分析

**2.1 ステージングされていない変更とステージング済み変更の取得**

```bash
git status
git diff HEAD --stat
git diff HEAD
```

**2.2 機密ファイルのチェック**

変更ファイルリストから以下のパターンを検出:
- `.env`, `.env.*`
- `*credentials*`, `*secret*`, `*password*`
- `*.key`, `*.pem`
- `config/database.yml`, `config/secrets.yml`

機密ファイルが含まれる場合は警告:
```
警告: 以下の機密ファイルが含まれています:
- {file1}
- {file2}

これらのファイルはコミットから除外されます。
```

**2.3 コミット対象ファイルの決定**

機密ファイルを除外したファイルリストを作成。

### 3. コミットメッセージの生成

**3.1 変更内容の分析**

diffとファイル名から以下を判定:
- **変更タイプ**: feat, fix, refactor, update, docs, test, chore
- **変更対象**: 主要な変更対象（ファイル名やdiffから抽出）
- **変更の目的**: diffの内容から推測

**3.2 メッセージの生成**

Claude.mdのルール「目的または意図が伝わるタイトル」に従い、以下の形式で生成:

```
{type}: {目的・意図を表す簡潔な説明}

Co-Authored-By: Claude (jp.anthropic.claude-sonnet-4-5-20250929-v1:0) <noreply@anthropic.com>
```

**タイプ別の例**:
- `feat: ユーザー認証機能を追加`
- `fix: ログイン時のセッションタイムアウトを修正`
- `refactor: API層のエラーハンドリングを改善`
- `update: ユーザー設定画面のUIを改善`
- `docs: READMEにセットアップ手順を追加`

**生成ルール**:
- 1行目は50文字以内を目標（最大70文字）
- 日本語で記述
- 「〜を追加」「〜を修正」など、動作を明確に
- 技術的な詳細は不要（タイトルのみ）

### 4. コミットの実行

**4.1 ファイルのステージング**

機密ファイルを除外してステージング:

```bash
git add {file1} {file2} {file3} ...
```

**重要**: `git add -A` や `git add .` は使用しない（機密ファイルの誤コミット防止）

**4.2 コミット**

HEREDOC形式でコミット:

```bash
git commit -m "$(cat <<'EOF'
{commit_message}
EOF
)"
```

### 5. リモートへのプッシュ

**5.1 プッシュ**

```bash
git push -u origin {current_branch}
```

**5.2 プッシュ失敗時の対応**

rejected（リモートに新しいコミットがある）場合:

```bash
git pull --rebase origin {current_branch}
```

rebase中にコンフリクトが発生した場合:
```
エラー: コンフリクトが発生しました。
以下のファイルを手動で解決してください:
{conflict_files}

解決後:
git add {resolved_files}
git rebase --continue
git push
```

rebaseが成功した場合、再度プッシュ:
```bash
git push
```

### 6. 結果表示

```
## コミット完了

**ブランチ**: {current_branch}
**コミットメッセージ**: {commit_message_first_line}
**変更ファイル**: {file_count}件

変更がリモートにプッシュされました。
```

## エラーハンドリング

| エラー | 対応 |
|--------|------|
| 変更がない | ファイルを編集してから実行するよう案内 |
| 機密ファイル検出 | 自動除外して続行（警告表示） |
| コンフリクト発生 | 手動解決の手順を案内 |
| プッシュ失敗 | rebaseして再プッシュ |
| rebase失敗 | 手動解決の手順を案内 |

## 注意事項

1. **絵文字の使用**: ユーザーが明示的に要求しない限り、絵文字を使わない
2. **機密ファイルの保護**: 自動検出して除外、警告を表示
3. **コミットメッセージの品質**: Claude.mdのルールに従い、目的・意図が伝わるタイトルを生成
4. **安全なステージング**: `git add .` は使用せず、ファイルを個別に指定
